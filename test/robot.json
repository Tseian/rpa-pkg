{
    "main": "/*\r\n图像自动去除背景服务\r\n*/\r\n\r\nfunction SVC_REMOVE_BG()\r\n{\r\n\tconst svcId='SERVICE.REMOVEBG';\r\n\tvar status=0,frameId,run_result={};;//0:停止 10:等待返回 20:等待图像处理\r\n\tvar _logicInService=new logicInService();//,_logicInPopupIFrame=new logicInPopupIFrame();\r\n\tvar buffer_logicInMainIFrame=_RPA_SYS_GetFunction(logicInMainIFrame);\r\n\tvar serviceData;\r\n\t\r\n\tthis.initial=function($$)\r\n\t{\r\n\t\tinitialServiceData({\r\n\t\t\tcallback:\r\n\t\t\t()=>\r\n\t\t\t{\r\n\t\t\t\t_logicInService.initial({logicInPopupIFrame:new logicInPopupIFrame(serviceData)});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t\r\n\tthis.getSvcId=function()\r\n\t{\r\n\t\treturn svcId;\r\n\t}\r\n\t\r\n\tthis._RPA_RELAY_EVENT=function($$)\r\n\t{\r\n\t\tsetTimeout(\r\n\t\t\t()=>\r\n\t\t\t{\r\n\t\t\t\t_logicInService.RPA_EventsLoop($$);\r\n\t\t\t},100\r\n\t\t)\r\n\t}\r\n\t\r\n\tthis._RPA_SYS_GETFUNCTION=function($$)\r\n\t{/*系统接口，用于获取要执行的代码*/\r\n\t\tvar url=$$.url,result;\r\n\t\t\r\n\t\tif(url.indexOf('https://www.remove.bg')!=-1)\r\n\t\t{\r\n\t\t\tresult={code:buffer_logicInMainIFrame};\r\n\t\t}\r\n\t\t\r\n\t\treturn result;\r\n\t}\r\n\r\n\tfunction initialServiceData($$)\r\n\t{/*\r\n\t\t应该从服务器返回，测试阶段放在本地目录下\r\n\t*/\r\n\t\tvar path=chrome.extension.getURL('/services/service_removebg.txt');\r\n\t\t\r\n\t\t_RPA_SYS_DownloadResource({src:path,\r\n\t\t\tcallback:\r\n\t\t\t\t(result)=>\r\n\t\t\t\t{\r\n\t\t\t\t\tserviceData=JSON.parse(result);\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(!!$$&&!!$$.callback)\r\n\t\t\t\t\t\t$$.callback();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t)\r\n\t}\r\n\r\n\t//服务端逻辑\r\n\tfunction logicInService()\r\n\t{\r\n\t\tvar _lPF;\r\n\t\t\r\n\t\tthis.initial=function($$)\r\n\t\t{//初始化\r\n\t\t\tinitial($$);\r\n\t\t\t_lPF=$$.logicInPopupIFrame;\r\n\t\t}\r\n\t\t\r\n\t\tthis.RPA_EventsLoop=function($$)\r\n\t\t{//对外的事件直接调用接口\r\n\t\t\tRPA_EventsLoop($$);\r\n\t\t}\r\n\t\t\r\n\t\tfunction removeByUrl($$)\r\n\t\t{/*\r\n\t\t\t根据url去除背景，向系统发送APP_RB_SEND_URL消息\r\n\t\t\t$$ {url:url}\r\n\t\t*/\r\n\t\t\tif(!!$$.data&&!!$$.data.url)\r\n\t\t\t{\r\n\t\t\t\t_RPA_CORE_SWITCH.raiseEvent({key:'APP_RB_SEND_URL',data:{url:$$.data.url}});\t\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tfunction removeByBase64($$)\r\n\t\t{/*\r\n\t\t\t根据url或者图像去除背景，向系统发送APP_RB_SEND_BASE64消息\r\n\t\t\t如果指定了url,则先下载后取base64；或者直接取base64\r\n\t\t\t$$ {url:url}或{base64:base64}\r\n\t\t*/\r\n\t\t\trun_result={};\r\n\t\t\t\r\n\t\t\tif(!!$$.data)\r\n\t\t\t{\r\n\t\t\t\tif(!!$$.data.url)\r\n\t\t\t\t{\r\n\t\t\t\t\t_RPA_SYS_DOWNLOAD_IMAGE({url:$$.data.url,resize:{process:getResize},callback:\r\n\t\t\t\t\t\t(result)=>\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\trun_result=result;\r\n\t\t\t\t\t\t\t_RPA_CORE_SWITCH.raiseEvent({key:'APP_RB_INNER_SEND_BASE64',data:{base64:!!result.resize?result.resize.base64:result.base64},svcId:svcId});\t\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tfunction getResize($$)\r\n\t\t{/*\r\n\t\t\tresize算法 $${width:width,height:height}\r\n\t\t\t1) 长，宽最大不超过500\r\n\t\t\t2) 如有超出，取大者，然后缩放\r\n\t\t*/\r\n\t\t\tlet width=$$.width,height=$$.height,value,bwidth,result,MAX=500;\r\n\t\t\t\r\n\t\t\tif(width>=height&&width>=MAX)\r\n\t\t\t{\r\n\t\t\t\tvalue=width;\r\n\t\t\t\tbwidth=true;\r\n\t\t\t}\r\n\t\t\telse if(height>=width&&height>=MAX)\r\n\t\t\t{\r\n\t\t\t\tvalue=height;\r\n\t\t\t\tbwidth=false;\t\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif(!!value)\r\n\t\t\t{\r\n\t\t\t\tlet ratio=parseInt(value/MAX),mod=value%MAX;\r\n\t\t\t\tif(!!mod)\r\n\t\t\t\t\tratio++;\r\n\t\t\t\t\r\n\t\t\t\tresult=bwidth?{width:width/ratio}:{height:height/ratio};\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\treturn result;\r\n\t\t}\r\n\t\t\r\n\t\tfunction initial()\r\n\t\t{/*\r\n\t\t\t初始化，包括登记response header拦截和request header请求\r\n\t\t*/\r\n\t\t\t_RPA_CORE_SWITCH.raiseEvent({key:'RPA_BR_FRAME_FUN_HOOKHEADER',data:{url:'https://www.remove.bg/*',data:[{name:'x-frame-options',value:'',comment:'删除禁止frame使用标志'}]},svcId:svcId});\r\n\t\t\t\r\n\t\t\t_RPA_CORE_SWITCH.registerEvents({callback:RPA_EventsLoop,keys:['APP_RB_SEND_URL','APP_RB_GOT_URL'],scope:'LOCALHOST'});\r\n\t\t\t_RPA_CORE_SWITCH.registerEvents({callback:RPA_EventsLoop,keys:['RPA_BR_POPUP_OPENTAB'],scope:svcId});\r\n\t\t\t\r\n\t\t\tframeId=_RPA_CORE_SWITCH.raiseEvent({key:'RPA_BR_FRAME_MAIN_CREATE_IFRAME',data:{url:_RPA_SYS_FORMAT_URL({svcId:svcId,url:'https://www.remove.bg'})}});\r\n\t\t}\r\n\t\t\r\n\t\tfunction RPA_EventsLoop($$)\r\n\t\t{/*\r\n\t\t\t服务端消息逻辑处理，主要是接收外部输入，包括请求和中间结果\r\n\t\t*/\r\n\t\t\tvar data,result,sender=$$.sender,svc;\r\n\t\t\t\r\n\t\t\tif(!!$$)\r\n\t\t\t{\r\n\t\t\t\tdata=$$.data;\r\n\t\t\t\t\r\n\t\t\t\tswitch($$.key)\r\n\t\t\t\t{\r\n\t\t\t\t\tcase 'APP_RB_SEND_URL'://根据url来去除背景，先由服务判断后，再用APP_RB_INNER_SEND_URL消息发送给实际的处理程序\r\n\t\t\t\t\t\tremoveByBase64($$);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'APP_RB_GOT_URL'://remove.bg的script发来的消息，包含remove去除背景后的链接,需要下载该图片，并进行合并逻辑处理\r\n\t\t\t\t\t\tlet url=(!!$$.data&&!!$$.data.url)?$$.data.url:null;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif(!!url)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t_RPA_SYS_DOWNLOAD_IMAGE({url:url,resize:{width:run_result.width},callback:\r\n\t\t\t\t\t\t\t\t(result)=>\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\trun_result.result=result;\r\n\t\t\t\t\t\t\t\t\tprocessImage(run_result);\r\n\t\t\t\t\t\t\t\t\t//向系统推送结果\r\n\t\t\t\t\t\t\t\t\t_RPA_CORE_SWITCH.raiseEvent({key:'APP_RB_GOT_RESULT',data:{base64:run_result.process.base64}});\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'RPA_BR_POPUP_OPENTAB':/*指定的tab页面打开了，需要动态返回消息*/\r\n\t\t\t\t\t\t//_RPA_CORE_SWITCH.raiseEvent({key:'RPA_BR_FRAME_POPUP_CREATE_IFRAME',data:_lPF._RPA_SYS_GETFUNCTION()});\r\n\t\t\t\t\t\tlet cdata=_lPF._RPA_SYS_GETFUNCTION(data);\r\n\t\t\t\t\t\t_RPA_CORE_SWITCH.raiseEvent({key:'RPA_BR_FRAME_POPUP_UPDATE_IFRAME',data:cdata});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tfunction processImage(idata)\r\n\t\t{/*\r\n\t\t\t最终的图像处理，根据remove.bg输出图和原始图缩放后对比，输出扣除后内容\r\n\t\t*/\r\n\t\t\t\r\n\t\t\tvar canvas,context,width=idata.width,height=idata.height,len,SPAN=3;\r\n\t\t\tvar data_origin,data_mask,data_origin_32,data_mask_32,bin;\r\n\t\t\t\r\n\t\t\tdata_origin=idata.data.imagedata;\r\n\t\t\tdata_origin_32=idata.data.data32;\r\n\t\t\t\r\n\t\t\tdata_mask=idata.result.resize.data.imagedata;\r\n\t\t\tdata_mask_32=idata.result.resize.data.data32;\r\n\t\t\t/*\r\n\t\t\t然后绘制图形，加上了偏差处理，记录是从进入还是离开，各取两个像素的偏差\r\n\t\t\t*/\r\n\t\t\tlen=data_mask_32.length;\r\n\t\t\tbin=true;\r\n\t\t\t\r\n\t\t\tfor(var ni=0;ni<len;ni+=4)\r\n\t\t\t{\r\n\t\t\t\tif(bin&&!!data_mask_32[ni+3])\r\n\t\t\t\t{/*改点以及后续SPAN各点均要设置为透明*/\r\n\t\t\t\t\tbin=false;\r\n\t\t\t\t\tdata_origin_32[ni+3]=0;\r\n\t\t\t\t\t\r\n\t\t\t\t\tfor(var nj=0;nj<SPAN;nj++)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tni+=4;\r\n\t\t\t\t\t\tif(ni+3<len)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tdata_origin_32[ni+3]=0;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse if(!bin&&!data_mask_32[ni+3])/*np==0,透明*/\r\n\t\t\t\t{/*\r\n\t\t\t\t\t\r\n\t\t\t\t*/\r\n\t\t\t\t\tbin=true;\r\n\t\t\t\t\tdata_origin_32[ni+3]=0;\r\n\t\t\t\t\tlet bni=ni;\r\n\t\t\t\t\t\r\n\t\t\t\t\tfor(var nj=0;nj<SPAN;nj++)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tni-=4;\r\n\t\t\t\t\t\tif(ni>=0)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tdata_origin_32[ni+3]=0;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse if(!data_mask_32[ni+3])\r\n\t\t\t\t{\r\n\t\t\t\t\tdata_origin_32[ni+3]=0;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tcanvas = document.createElement('canvas');\r\n\t\t\tcontext = canvas.getContext('2d');\r\n\t\t\tcontext.imageSmoothingQuality = 'high';\r\n\t\t\tcanvas.width = width;\r\n\t\t\tcanvas.height = height;\r\n\t\t\t\r\n\t\t\tdata_origin.data.set(Uint8ClampedArray.from(data_origin_32));\r\n\t\t\t\r\n\t\t\tcontext.putImageData(data_origin,0, 0);\r\n\t\t\t\r\n\t\t\tidata.process={base64:canvas.toDataURL('image/png')};\r\n\t\t\t\r\n\t\t\tdelete context;\r\n\t\t\tdelete canvas;\r\n\t\t}\r\n\t\t\r\n\t\t//initial();\r\n\t}\r\n\r\n\t//用于popup窗口iframe中嵌入逻辑\r\n\tfunction logicInPopupIFrame(data)\r\n\t{\r\n\t\t/*此处为popup iframe中的html代码*/\r\n\t\t//var html=`<!DOCTYPE html><html><head><meta charset=utf-8></head><body><input style='width:200px' id='url' value='https://ae01.alicdn.com/kf/H5ba64a0fa4c741388cfb4b549d89bb6e7/Long-Sleeve-Shirt-Dress-2019-Summer-Boho-Beach-Dresses-Women-Casual-Striped-Print-A-line-Mini.jpg'><br><input type='button' value='抠图' style='margin-left:50px' id='btn'><br><img id='result' style='width:300px'></body><script src='/js/sys_core_inject.js'></script></html>`;\r\n\t\tvar frameData=data;\r\n\t\t\r\n\t\tthis._RPA_SYS_GETFUNCTION=function($$)\r\n\t\t{/*获取popup端 代码*/\r\n\t\t\tvar frmId=$$.frmId,tabId=$$.tabId;\r\n\t\t\tvar result;;\r\n\t\t\t\r\n\t\t\tswitch(tabId)\r\n\t\t\t{\r\n\t\t\t\tcase '1':\r\n\t\t\t\t\t//result={html:frameData.html,code:_RPA_SYS_GetFunction(rbIFrameInject),frmId:frmId};\r\n\t\t\t\t\tresult={html:frameData.html,code:frameData.code,frmId:frmId};\r\n\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tresult={html:'hehda',frmId:frmId};\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\treturn result;\r\n\t\t}\r\n\t\t\r\n\t\tfunction rbIFrameInject()\r\n\t\t{/*包含代码将在popup对应的iframe中执行*/\r\n\t\t\tfunction RPA_EventsLoop($$)\r\n\t\t\t{\r\n\t\t\t\tvar data=!!$$?$$.data:null,result,sender=$$.sender,svc,rt;\r\n\t\t\t\t\r\n\t\t\t\tif(!!$$)\r\n\t\t\t\t{\r\n\t\t\t\t\tswitch($$.key)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcase 'APP_RB_GOT_RESULT':/*获取到去除后结果*/\r\n\t\t\t\t\t\t\tdocument.getElementById('result').src=data.base64;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t_RPA_CORE_SWITCH.registerEvents({keys:'APP_RB_GOT_RESULT',scope:'LOCALHOST',callback:RPA_EventsLoop});\r\n\t\t\t\r\n\t\t\tdocument.querySelector('#btn').onclick=\r\n\t\t\t()=>\r\n\t\t\t{\r\n\t\t\t\t_RPA_CORE_SWITCH.raiseEvent({key:'APP_RB_SEND_URL',data:{url:document.querySelector('#url').value},scope:'LOCALHOST'});\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\twindow.RPA_EventsLoop=RPA_EventsLoop;\r\n\t\t\t\r\n\t\t\tconsole.log('popup here');\r\n\t\t}\r\n\t}\r\n\t\r\n\t//用于main窗口iframe中嵌入逻辑，用于调度remove.bg功能\r\n\tfunction logicInMainIFrame()\r\n\t{\r\n\t\tfunction rbIFrameInject()\r\n\t\t{/*包含代码将在remove.bg原生环境下执行*/\r\n\t\t\tvar _RPA_INJECT_HANDLER,_RPA_requestData={},_RPA_TIMER;\r\n\t\t\r\n\t\t\tfunction _RPA_INJECT_getHandler()\r\n\t\t\t{/*获取控制句柄*/\r\n\t\t\t\tlet keys = Object.keys(document.body);\r\n\t\t\t\tlet find = keys.find(k => k.includes('jQuery'));\r\n\t\t\t\t\r\n\t\t\t\tif (find) \r\n\t\t\t\t{\r\n\t\t\t\t\tlet bindEvents = document.body[find];\r\n\t\t\t\t\tlet handlers = bindEvents.events.paste;\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(!!handlers[0])\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t_RPA_INJECT_HANDLER=handlers[0].handler;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfunction base64ToFile(imgBase64) {\r\n\t\t\t/*base64转文件*/\r\n\t\t\t\tlet bsArr = imgBase64.split(',');\r\n\t\t\t\tconst bs = bsArr[1];\r\n\t\t\t\tconst type = bsArr[0].replace('data:', '').replace(';base64', '');\r\n\t\t\t\tconst byteCharacters = window.atob(bs);\r\n\t\t\t\tconst byteNumbers = new Array(byteCharacters.length);\r\n\t\t\t\tfor (let i = 0; i < byteCharacters.length; i++) {\r\n\t\t\t\t\tbyteNumbers[i] = byteCharacters.charCodeAt(i);\r\n\t\t\t\t}\r\n\t\t\t\tconst byteArray = new Uint8Array(byteNumbers);\r\n\t\t\t\tconst file = new File([byteArray], 'test.png', {type: type.trim()});\r\n\t\t\t\treturn file;\r\n\t\t\t}\r\n\t\t\r\n\t\t\tfunction _RPA_INJECT_sendUrl(url)\r\n\t\t\t{/*发送图像url*/\r\n\t\t\t\tif(!_RPA_INJECT_HANDLER)\r\n\t\t\t\t{\r\n\t\t\t\t\t_RPA_INJECT_getHandler();\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\tif(!!_RPA_INJECT_HANDLER)\r\n\t\t\t\t{\r\n\t\t\t\t\t_RPA_INJECT_HANDLER(\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\toriginalEvent: {\r\n\t\t\t\t\t\t\t\ttarget: {\r\n\t\t\t\t\t\t\t\t\tis: ()=>{ return false }\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\tclipboardData: {\r\n\t\t\t\t\t\t\t\t\titems: [{\r\n\t\t\t\t\t\t\t\t\t\ttype: \"text/plain\",\r\n\t\t\t\t\t\t\t\t\t\tgetAsString: (cb)=> {\r\n\t\t\t\t\t\t\t\t\t\t\tcb(url)\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}]\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfunction _RPA_INJECT_sendBase64(base64)\r\n\t\t\t{/*发送base64图像*/\r\n\t\t\t\tif(!_RPA_INJECT_HANDLER)\r\n\t\t\t\t{\r\n\t\t\t\t\t_RPA_INJECT_getHandler();\r\n\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\tif(!!_RPA_INJECT_HANDLER)\r\n\t\t\t\t{\r\n\t\t\t\t\t_RPA_INJECT_HANDLER(\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\toriginalEvent: {\r\n\t\t\t\t\t\t\t\ttarget: {\r\n\t\t\t\t\t\t\t\t\tis: ()=>{ return false }\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\tclipboardData: {\r\n\t\t\t\t\t\t\t\t\titems: [{\r\n\t\t\t\t\t\t\t\t\t\ttype: \"image/*\",\r\n\t\t\t\t\t\t\t\t\t\tgetAsFile: function() {\r\n\t\t\t\t\t\t\t\t\t\t\treturn base64ToFile(base64);\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}]\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfunction _RPA_checkImage()\r\n\t\t\t{/*\r\n\t\t\t\t检测是否有图像生成\r\n\t\t\t*/\r\n\t\t\t\tvar img=document.querySelector('img[data-hj-suppress][src*=\"/downloads/\"]'),clear=document.querySelector('a.image-result--delete-btn');\r\n\t\t\t\t\r\n\t\t\t\tif(!!img)//&&!!img.width)\r\n\t\t\t\t{\r\n\t\t\t\t\t_RPA_CORE_SWITCH.raiseEvent({key:'APP_RB_GOT_URL',data:{url:img.src}});\r\n\t\t\t\t\t\r\n\t\t\t\t\tclearInterval(_RPA_TIMER);\r\n\r\n\t\t\t\t\tif(!!clear)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tclear.click();\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\timg.parentNode.removeChild(img);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfunction RPA_EventsLoop($$)\r\n\t\t\t{/*\r\n\t\t\t处理消息队列，由switch调用\r\n\t\t\t*/\r\n\t\t\t\tvar data,result,sender=$$.sender,svc;\r\n\t\t\t\t\r\n\t\t\t\tif(!!$$)\r\n\t\t\t\t{\r\n\t\t\t\t\tdata=$$.data;\r\n\t\t\t\t\t\r\n\t\t\t\t\tswitch($$.key)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcase 'APP_RB_INNER_SEND_URL':/*通过url来去除背景*/\r\n\t\t\t\t\t\tcase 'APP_RB_INNER_SEND_BASE64':/*通过base64来去除背景*/\r\n\t\t\t\t\t\t\tif(!!data&&(!!data.url||!!data.base64))\r\n\t\t\t\t\t\t\t{\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tif($$.key=='APP_RB_SEND_URL')\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t_RPA_INJECT_sendUrl(data.url);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t_RPA_INJECT_sendBase64(data.base64);\t\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t/*启动检测*/\r\n\t\t\t\t\t\t\t\t_RPA_TIMER=setInterval(_RPA_checkImage,100);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t//设置全局变量\r\n\t\t\twindow.RPA_EventsLoop=RPA_EventsLoop;\r\n\t\t\t//注册本地全局事件，捕获\r\n\t\t\t_RPA_CORE_SWITCH.registerEvents({keys:['APP_RB_INNER_SEND_URL','APP_RB_INNER_SEND_BASE64'],callback:RPA_EventsLoop});\r\n\t\t\tconsole.log('heheda');\r\n\t\t}\r\n\r\n\t\t_RPA_SYS_GET_SCRIPT({type:20,src:chrome.extension.getURL('/js/sys_core_inject.js'),callback:\r\n\t\t\t()=>\r\n\t\t\t{\r\n\t\t\t\t_RPA_SYS_GET_SCRIPT({type:0,src:rbIFrameInject});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t\r\n\treturn this;\r\n}",
    "mainIframe": [
        {
            "name": "a.html",
            "codes": [
                "console.log(\"outline script\");",
                "\n        console.log(\"inline script\");\n    "
            ],
            "html": "<!DOCTYPE html><html><head>\n    <title>Document</title>\n</head>\n\n<body>\n    <!-- 引入样式 -->\n    <link rel=\"stylesheet\" href=\"./base/assets/element-ui@2.12.0.css\">\n    \n    <style>\n        .cutout-features {\n            background: #fff;\n        }\n\n        .cutout-features-card {\n            border: 1px solid #ebeef5;\n            box-shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.1);\n            border-radius: 4px;\n            background-color: #fff;\n            overflow: hidden;\n            color: #303133;\n            transition: 0.3s;\n            padding: 0 20px;\n            margin-bottom: 12px;\n        }\n\n        .cutout-upload {\n            padding-bottom: 20px;\n        }\n\n        .cutout-upload .el-upload {\n            width: 100%;\n        }\n\n        .cutout-upload .el-upload-dragger {\n            width: 100%;\n        }\n\n        .el-icon-close {\n            display: none !important;\n        }\n\n        .cutout-features-title {\n            font-size: 16px;\n            color: #4a545d;\n        }\n\n        .el-upload-dragger {\n            height: 130px;\n        }\n\n        .el-icon-upload {\n            margin: 24px 0 16px !important;\n        }\n\n        .el-upload-dragger:hover,\n        .el-upload-dragger:hover>.el-icon-upload,\n        .el-upload-dragger:hover>.ex-features-upload {\n            color: #015ca5;\n        }\n\n        .cutout-features-btn {\n            background-color: #00457d !important;\n            border-color: #00457d !important;\n            color: #fff !important;\n        }\n\n        .cutout-features-btn:hover {\n            background-color: #015ca5 !important;\n            border-color: #015ca5 !important;\n            color: #fff !important;\n        }\n    </style>\n    <!-- 引入组件库 -->\n    \n    <script src=\"./base/assets/vue.js\"></script>\n    <script src=\"./base/element-ui@2.12.0.js\"></script>\n    <script src=\"./base/js/sys_core_inject.js\"></script>\n    \n\n\n\n<style>\n.test {\n    color     : red;\n    background: 0%\n}\n</style>\n</body></html>"
        },
        {
            "name": "features.html",
            "codes": [
                "console.log(\"outline script\");",
                "\n    const cut = {\n        set: function (val) {\n            if (typeof this.imageHandle === 'function') {\n                imageHandle(val)\n            }\n        },\n        imageHandle: null\n    }\n\n    window.RPA_EventsLoop = function ($$) {\n        var data = !!$$ ? $$.data : null, result, sender = $$.sender, svc, rt;\n        if (!!$$) {\n            switch ($$.key) {\n                case 'APP_RB_GOT_RESULT':/*获取到去除后结果*/\n                    cut.set(data.base64)\n                    break;\n            }\n        }\n    }\n\n    new Vue({\n        el: '#features',\n        data() {\n            return {\n                urlForm: {\n                    url: \"\"\n                },\n                show: false,\n                imageSize: 150,\n                imageFit: 'fill',\n                imageShape: 'square',\n                cutoutImg: ''\n            };\n        },\n        computed: {\n            cutoutImage() {\n                return this.cutoutImg\n            }\n        },\n        mounted() {\n            cut.imageHandle = this.imageHandle\n        },\n        methods: {\n            imageHandle(val) {\n                this.cutoutImg = val\n            },\n            // URL 提交\n            submitForm(formName) {\n                let _self = this\n                this.$refs[formName].validate(function (valid) {\n                    if (valid) {\n                        _self.show = true\n                        _RPA_CORE_SWITCH.raiseEvent({ key: 'APP_RB_SEND_URL', data: { 'url': _self.urlForm.url }, scope: 'LOCALHOST' })\n                    }\n                })\n            },\n            // 重置URL\n            resetForm(formName) {\n                this.$refs[formName].resetFields()\n            },\n            // 选择文件提交\n            handleFile(file, fileList) {\n                this.turnToBase64(file.raw).then(function (res) {\n                    _RPA_CORE_SWITCH.raiseEvent({ key: 'APP_RB_SEND_URL', data: { 'base64': res }, scope: 'LOCALHOST' })\n                })\n            },\n            // 将图片转为base64\n            turnToBase64(file) {\n                // FileReader 无法return，故借助 Promise\n                return new Promise(function (resolve, reject) {\n                    let reader = new FileReader()\n                    let imageBase = \"\"\n                    // 开始读取指定的Blob中的内容。一旦完成，result属性中将包含一个data: URL格式的Base64字符串以表示所读取文件的内容\n                    reader.readAsDataURL(file)\n                    // 处理load事件。该事件在读取操作完成时触发\n                    reader.onload = function () {\n                        imageBase = reader.result\n                    }\n                    // 处理error事件。该事件在读取操作发生错误时触发\n                    reader.onerror = function (error) {\n                        reject(error)\n                    }\n                    // 处理loadend事件。该事件在读取操作结束时（要么成功，要么失败）触发\n                    reader.onloadend = function () {\n                        resolve(imageBase)\n                    }\n                })\n            },\n\n            // demo\n            preview(image) {\n                window.open(image)\n            },\n            previewBase64(image) {\n                let w = window.open(\"\");\n                w.document.body.innerHTML = `<img src=${image}>`;\n            }\n        },\n        created() {\n            _RPA_CORE_SWITCH.registerEvents({ keys: 'APP_RB_GOT_RESULT', scope: 'LOCALHOST', callback: RPA_EventsLoop });\n        }\n    })\n\n"
            ],
            "html": "<html><head></head><body>﻿\n\n\n\n    <meta charset=\"utf-8\">\n    <base href=\"./user_data/\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n    <title>features</title>\n\n\n\n    <div id=\"features\" class=\"cutout-features\">\n        <div class=\"cutout-features-card\">\n            <h3 class=\"cutout-features-title\">\n                外链上传\n            </h3>\n            <el-form :model=\"urlForm\" ref=\"urlForm\" label-width=\"40px\">\n                <el-form-item label=\"URL\" prop=\"url\" :rules=\"[{ required: true, message: 'URL不能为空'}]\">\n                    <el-input type=\"text\" v-model=\"urlForm.url\"></el-input>\n                </el-form-item>\n                <el-form-item>\n                    <el-button class=\"cutout-features-btn\" @click=\"submitForm('urlForm')\">上传</el-button>\n                    <el-button @click=\"resetForm('urlForm')\">重置</el-button>\n                </el-form-item>\n            </el-form>\n        </div>\n        <ul class=\"cutout-features-card cutout-upload\" v-if=\"show\">\n            <h3 class=\"cutout-features-title\">\n                任务列表\n            </h3>\n            <li class=\"cutout-list-item\">\n                <div class=\"cutout-preview\" @click=\"preview(urlForm.url)\" style=\"cursor: pointer;\">\n                    <el-avatar :shape=\"imageShape\" :size=\"imageSize\" :src=\"urlForm.url\" :fit=\"imageFit\">\n                    </el-avatar>\n                </div>\n                <div class=\"cutout-preview\" @click=\"previewBase64(cutoutImage)\" style=\"cursor: pointer;\">\n                    <el-avatar :shape=\"imageShape\" :size=\"imageSize\" :src=\"cutoutImage\" :fit=\"imageFit\">\n                        <span v-if=\"!cutoutImage\">加载中...</span>\n                    </el-avatar>\n                </div>\n            </li>\n        </ul>\n    </div>\n\n\n<link rel=\"stylesheet\" href=\"./base/assets/element-ui@2.12.0.css\">\n\n<style>\n    .cutout-features {\n        background: #fff;\n    }\n\n    .cutout-features-card {\n        border: 1px solid #ebeef5;\n        box-shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.1);\n        border-radius: 4px;\n        background-color: #fff;\n        overflow: hidden;\n        color: #303133;\n        transition: 0.3s;\n        padding: 0 20px;\n        margin-bottom: 12px;\n    }\n\n    .cutout-upload {\n        padding-bottom: 20px;\n    }\n\n    .cutout-upload .el-upload {\n        width: 100%;\n    }\n\n    .cutout-upload .el-upload-dragger {\n        width: 100%;\n    }\n\n    .el-icon-close {\n        display: none !important;\n    }\n\n    .cutout-features-title {\n        font-size: 16px;\n        color: #4a545d;\n    }\n\n    .el-upload-dragger {\n        height: 130px;\n    }\n\n    .el-icon-upload {\n        margin: 24px 0 16px !important;\n    }\n\n    .el-upload-dragger:hover,\n    .el-upload-dragger:hover>.el-icon-upload,\n    .el-upload-dragger:hover>.ex-features-upload {\n        color: #015ca5;\n    }\n\n    .cutout-features-btn {\n        background-color: #00457d !important;\n        border-color: #00457d !important;\n        color: #fff !important;\n    }\n\n    .cutout-features-btn:hover {\n        background-color: #015ca5 !important;\n        border-color: #015ca5 !important;\n        color: #fff !important;\n    }\n</style>\n\n<!-- 引入组件库 -->\n<script src=\"./base/assets/vue.js\"></script>\n<script src=\"./base/assets/element-ui@2.12.0.js\"></script>\n<script src=\"./base/js/sys_core_inject.js\"></script>\n\n\n\n\n\n<style>\n.cutout-list {\n    padding: 10px;\n}\n\n.cutout-list-item {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    overflow: hidden;\n    border-bottom: 1px solid #ddd;\n}\n\n.cutout-preview {\n    text-align: center;\n    margin-right: 10px;\n}\n</style>\n</body><!-- 引入样式 --></html>"
        }
    ],
    "popupIframe": [
        {
            "name": "a.html",
            "codes": [
                "console.log(\"outline script\");",
                "\n        console.log(\"inline script\");\n    "
            ],
            "html": "<!DOCTYPE html><html><head>\n    <title>Document</title>\n</head>\n\n<body>\n    <!-- 引入样式 -->\n    <link rel=\"stylesheet\" href=\"./base/assets/element-ui@2.12.0.css\">\n    \n    <style>\n        .cutout-features {\n            background: #fff;\n        }\n\n        .cutout-features-card {\n            border: 1px solid #ebeef5;\n            box-shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.1);\n            border-radius: 4px;\n            background-color: #fff;\n            overflow: hidden;\n            color: #303133;\n            transition: 0.3s;\n            padding: 0 20px;\n            margin-bottom: 12px;\n        }\n\n        .cutout-upload {\n            padding-bottom: 20px;\n        }\n\n        .cutout-upload .el-upload {\n            width: 100%;\n        }\n\n        .cutout-upload .el-upload-dragger {\n            width: 100%;\n        }\n\n        .el-icon-close {\n            display: none !important;\n        }\n\n        .cutout-features-title {\n            font-size: 16px;\n            color: #4a545d;\n        }\n\n        .el-upload-dragger {\n            height: 130px;\n        }\n\n        .el-icon-upload {\n            margin: 24px 0 16px !important;\n        }\n\n        .el-upload-dragger:hover,\n        .el-upload-dragger:hover>.el-icon-upload,\n        .el-upload-dragger:hover>.ex-features-upload {\n            color: #015ca5;\n        }\n\n        .cutout-features-btn {\n            background-color: #00457d !important;\n            border-color: #00457d !important;\n            color: #fff !important;\n        }\n\n        .cutout-features-btn:hover {\n            background-color: #015ca5 !important;\n            border-color: #015ca5 !important;\n            color: #fff !important;\n        }\n    </style>\n    <!-- 引入组件库 -->\n    \n    <script src=\"./base/assets/vue.js\"></script>\n    <script src=\"./base/element-ui@2.12.0.js\"></script>\n    <script src=\"./base/js/sys_core_inject.js\"></script>\n    \n\n\n\n<style>\n.test {\n    color     : red;\n    background: 0%\n}\n</style>\n</body></html>"
        },
        {
            "name": "features.html",
            "codes": [
                "console.log(\"outline script\");",
                "\n    const cut = {\n        set: function (val) {\n            if (typeof this.imageHandle === 'function') {\n                imageHandle(val)\n            }\n        },\n        imageHandle: null\n    }\n\n    window.RPA_EventsLoop = function ($$) {\n        var data = !!$$ ? $$.data : null, result, sender = $$.sender, svc, rt;\n        if (!!$$) {\n            switch ($$.key) {\n                case 'APP_RB_GOT_RESULT':/*获取到去除后结果*/\n                    cut.set(data.base64)\n                    break;\n            }\n        }\n    }\n\n    new Vue({\n        el: '#features',\n        data() {\n            return {\n                urlForm: {\n                    url: \"\"\n                },\n                show: false,\n                imageSize: 150,\n                imageFit: 'fill',\n                imageShape: 'square',\n                cutoutImg: ''\n            };\n        },\n        computed: {\n            cutoutImage() {\n                return this.cutoutImg\n            }\n        },\n        mounted() {\n            cut.imageHandle = this.imageHandle\n        },\n        methods: {\n            imageHandle(val) {\n                this.cutoutImg = val\n            },\n            // URL 提交\n            submitForm(formName) {\n                let _self = this\n                this.$refs[formName].validate(function (valid) {\n                    if (valid) {\n                        _self.show = true\n                        _RPA_CORE_SWITCH.raiseEvent({ key: 'APP_RB_SEND_URL', data: { 'url': _self.urlForm.url }, scope: 'LOCALHOST' })\n                    }\n                })\n            },\n            // 重置URL\n            resetForm(formName) {\n                this.$refs[formName].resetFields()\n            },\n            // 选择文件提交\n            handleFile(file, fileList) {\n                this.turnToBase64(file.raw).then(function (res) {\n                    _RPA_CORE_SWITCH.raiseEvent({ key: 'APP_RB_SEND_URL', data: { 'base64': res }, scope: 'LOCALHOST' })\n                })\n            },\n            // 将图片转为base64\n            turnToBase64(file) {\n                // FileReader 无法return，故借助 Promise\n                return new Promise(function (resolve, reject) {\n                    let reader = new FileReader()\n                    let imageBase = \"\"\n                    // 开始读取指定的Blob中的内容。一旦完成，result属性中将包含一个data: URL格式的Base64字符串以表示所读取文件的内容\n                    reader.readAsDataURL(file)\n                    // 处理load事件。该事件在读取操作完成时触发\n                    reader.onload = function () {\n                        imageBase = reader.result\n                    }\n                    // 处理error事件。该事件在读取操作发生错误时触发\n                    reader.onerror = function (error) {\n                        reject(error)\n                    }\n                    // 处理loadend事件。该事件在读取操作结束时（要么成功，要么失败）触发\n                    reader.onloadend = function () {\n                        resolve(imageBase)\n                    }\n                })\n            },\n\n            // demo\n            preview(image) {\n                window.open(image)\n            },\n            previewBase64(image) {\n                let w = window.open(\"\");\n                w.document.body.innerHTML = `<img src=${image}>`;\n            }\n        },\n        created() {\n            _RPA_CORE_SWITCH.registerEvents({ keys: 'APP_RB_GOT_RESULT', scope: 'LOCALHOST', callback: RPA_EventsLoop });\n        }\n    })\n\n"
            ],
            "html": "<html><head></head><body>﻿\n\n\n\n    <meta charset=\"utf-8\">\n    <base href=\"./user_data/\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n    <title>features</title>\n\n\n\n    <div id=\"features\" class=\"cutout-features\">\n        <div class=\"cutout-features-card\">\n            <h3 class=\"cutout-features-title\">\n                外链上传\n            </h3>\n            <el-form :model=\"urlForm\" ref=\"urlForm\" label-width=\"40px\">\n                <el-form-item label=\"URL\" prop=\"url\" :rules=\"[{ required: true, message: 'URL不能为空'}]\">\n                    <el-input type=\"text\" v-model=\"urlForm.url\"></el-input>\n                </el-form-item>\n                <el-form-item>\n                    <el-button class=\"cutout-features-btn\" @click=\"submitForm('urlForm')\">上传</el-button>\n                    <el-button @click=\"resetForm('urlForm')\">重置</el-button>\n                </el-form-item>\n            </el-form>\n        </div>\n        <ul class=\"cutout-features-card cutout-upload\" v-if=\"show\">\n            <h3 class=\"cutout-features-title\">\n                任务列表\n            </h3>\n            <li class=\"cutout-list-item\">\n                <div class=\"cutout-preview\" @click=\"preview(urlForm.url)\" style=\"cursor: pointer;\">\n                    <el-avatar :shape=\"imageShape\" :size=\"imageSize\" :src=\"urlForm.url\" :fit=\"imageFit\">\n                    </el-avatar>\n                </div>\n                <div class=\"cutout-preview\" @click=\"previewBase64(cutoutImage)\" style=\"cursor: pointer;\">\n                    <el-avatar :shape=\"imageShape\" :size=\"imageSize\" :src=\"cutoutImage\" :fit=\"imageFit\">\n                        <span v-if=\"!cutoutImage\">加载中...</span>\n                    </el-avatar>\n                </div>\n            </li>\n        </ul>\n    </div>\n\n\n<link rel=\"stylesheet\" href=\"./base/assets/element-ui@2.12.0.css\">\n\n<style>\n    .cutout-features {\n        background: #fff;\n    }\n\n    .cutout-features-card {\n        border: 1px solid #ebeef5;\n        box-shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.1);\n        border-radius: 4px;\n        background-color: #fff;\n        overflow: hidden;\n        color: #303133;\n        transition: 0.3s;\n        padding: 0 20px;\n        margin-bottom: 12px;\n    }\n\n    .cutout-upload {\n        padding-bottom: 20px;\n    }\n\n    .cutout-upload .el-upload {\n        width: 100%;\n    }\n\n    .cutout-upload .el-upload-dragger {\n        width: 100%;\n    }\n\n    .el-icon-close {\n        display: none !important;\n    }\n\n    .cutout-features-title {\n        font-size: 16px;\n        color: #4a545d;\n    }\n\n    .el-upload-dragger {\n        height: 130px;\n    }\n\n    .el-icon-upload {\n        margin: 24px 0 16px !important;\n    }\n\n    .el-upload-dragger:hover,\n    .el-upload-dragger:hover>.el-icon-upload,\n    .el-upload-dragger:hover>.ex-features-upload {\n        color: #015ca5;\n    }\n\n    .cutout-features-btn {\n        background-color: #00457d !important;\n        border-color: #00457d !important;\n        color: #fff !important;\n    }\n\n    .cutout-features-btn:hover {\n        background-color: #015ca5 !important;\n        border-color: #015ca5 !important;\n        color: #fff !important;\n    }\n</style>\n\n<!-- 引入组件库 -->\n<script src=\"./base/assets/vue.js\"></script>\n<script src=\"./base/assets/element-ui@2.12.0.js\"></script>\n<script src=\"./base/js/sys_core_inject.js\"></script>\n\n\n\n\n\n<style>\n.cutout-list {\n    padding: 10px;\n}\n\n.cutout-list-item {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    overflow: hidden;\n    border-bottom: 1px solid #ddd;\n}\n\n.cutout-preview {\n    text-align: center;\n    margin-right: 10px;\n}\n</style>\n</body><!-- 引入样式 --></html>"
        }
    ],
    "winIframe": []
}